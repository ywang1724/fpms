"use strict";var ApplicationConfiguration=function(){var a="fpms",b=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","datatables","mgcrea.ngStrap","ngLocale","highcharts-ng","ngClipboard"],c=function(b,c){angular.module(b,c||[]),angular.module(a).requires.push(b)};return{applicationModuleName:a,applicationModuleVendorDependencies:b,registerModule:c}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function(a){a.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("apps"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("users"),angular.module("apps").run(["Menus",function(a){a.addMenuItem("topbar","我的应用","apps","dropdown","/apps(/create)?","false",["user"]),a.addSubMenuItem("topbar","apps","应用列表","apps"),a.addSubMenuItem("topbar","apps","添加应用","apps/create"),a.addMenuItem("topbar","应用列表","apps","item","/apps","false",["admin"])}]),angular.module("apps").config(["$datepickerProvider",function(a){angular.extend(a.defaults,{animation:"am-flip-x",autoclose:!0,dateType:"number"})}]),angular.module("apps").config(["$selectProvider",function(a){angular.extend(a.defaults,{animation:"am-flip-x"})}]),angular.module("apps").config(["$tooltipProvider",function(a){angular.extend(a.defaults,{animation:"am-flip-x",trigger:"hover",placement:"bottom",type:"success"})}]),angular.module("apps").config(["ngClipProvider",function(a){a.setPath("lib/zeroclipboard/dist/ZeroClipboard.swf")}]),angular.module("apps").config(["$stateProvider",function(a){a.state("listApps",{url:"/apps",templateUrl:"modules/apps/views/app/list-apps.client.view.html"}).state("createApp",{url:"/apps/create",templateUrl:"modules/apps/views/app/create-app.client.view.html"}).state("viewApp",{url:"/apps/:appId",templateUrl:"modules/apps/views/app/view-app.client.view.html"}).state("editApp",{url:"/apps/:appId/edit",templateUrl:"modules/apps/views/app/edit-app.client.view.html"})}]),angular.module("apps").controller("AppsController",["$scope","$stateParams","$location","Authentication","Apps","DTOptionsBuilder","$http","$timeout",function(a,b,c,d,e,f,g,h){a.authentication=d,a.type="java",a.types=["java","node.js","android","ios"],d.user&&(a.showName="admin"===d.user.roles[0]?!0:!1),a.script='<script type="text/javascript">var fp = document.createElement("script");fp.type = "text/javascript";fp.async = true;fp.src = "http://'+c.host()+":"+c.port()+"/rookie.js/"+b.appId+'";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(fp, s);</script>',a.create=function(){var b=new e({name:this.name,type:this.type,host:this.host});b.$save(function(b){c.path("apps/"+b._id),a.name="",a.type="java",a.host=""},function(b){a.error=b.data.message})},a.remove=function(b){if(b){b.$remove();for(var d in a.apps)a.apps[d]===b&&a.apps.splice(d,1)}else a.app.$remove(function(){c.path("apps")})},a.update=function(){var b=a.app;b.$update(function(){c.path("apps/"+b._id)},function(b){a.error=b.data.message})},a.find=function(){a.apps=e.query()},a.findOne=function(){a.showData=!0,a.app=e.get({appId:b.appId}),Highcharts.setOptions({lang:{contextButtonTitle:"导出",printChart:"打印图表",downloadJPEG:"下载JPEG",downloadPDF:"下载PDF",downloadPNG:"下载PNG",downloadSVG:"下载SVG"}}),g.get("pages/"+b.appId).success(function(b){if(a.pagesNum=b.length||0,b.length){a.showChart=!0;for(var c=[],d=0;d<b.length;d++)c.push(b[d]._id);a.pages=[{_id:c,pathname:"全部"}].concat(b),a.selectPage=a.pages[0],a.intervals=[{name:"日",id:"day"},{name:"月",id:"month"},{name:"年",id:"year"}],a.selectInterval=a.intervals[0],a.browsers=[{name:"全部",id:"all"},{name:"Internet Explorer",id:"Internet Explorer"},{name:"Chrome",id:"Chrome"},{name:"Android Webkit Browser",id:"Android Webkit Browser"},{name:"Firefox",id:"Firefox"},{name:"Safari",id:"Safari"}],a.selectBrowser=a.browsers[0],a.statistics=[{name:"平均值",id:"mean"},{name:"中位数",id:"median"},{name:"p90",id:"quantile_90"}],a.selectStatistic=a.statistics[0];var e=new Date;a.nowDate=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),a.fromDate=a.nowDate-1296e6,a.untilDate=a.nowDate;var f=function(){a.details=[];var b,c;switch(a.selectInterval.id){case"day":b=a.fromDate,c=a.untilDate+864e5,a.chartConfig.xAxis.tickInterval=864e5,a.chartConfig.xAxis.dateTimeLabelFormats={day:"%m.%d"},a.chartConfig.options.tooltip.xDateFormat="%Y-%m-%d";break;case"month":b=Date.UTC(new Date(a.fromDate).getFullYear(),new Date(a.fromDate).getMonth()),c=Date.UTC(new Date(a.untilDate).getFullYear(),new Date(a.untilDate).getMonth()+1),a.chartConfig.xAxis.tickInterval=24192e5,a.chartConfig.xAxis.dateTimeLabelFormats={month:"%Y.%m"},a.chartConfig.options.tooltip.xDateFormat="%Y.%m";break;case"year":b=Date.UTC(new Date(a.fromDate).getFullYear(),0),c=Date.UTC(new Date(a.untilDate).getFullYear()+1,0),a.chartConfig.xAxis.tickInterval=31104e6,a.chartConfig.xAxis.dateTimeLabelFormats={day:"%Y"},a.chartConfig.options.tooltip.xDateFormat="%Y"}switch(a.selectStatistic.id){case"mean":a.chartConfig.title.text="页面性能总体趋势图（平均值）";break;case"median":a.chartConfig.title.text="页面性能总体趋势图（中位数）";break;case"quantile_90":a.chartConfig.title.text="页面性能总体趋势图（p90）"}g.get("timings",{params:{pageId:a.selectPage._id,fromDate:new Date(b),untilDate:new Date(c),interval:a.selectInterval.id,browser:a.selectBrowser.id,statistic:a.selectStatistic.id}}).success(function(b){b.statisticData.sum>0?(a.chartConfig.series[0].data=b.numData,a.chartConfig.series[1].data=b.pageLoadData,a.chartConfig.series[2].data=b.networkData,a.chartConfig.series[3].data=b.backendData,a.chartConfig.series[4].data=b.frontendData,a.chartConfig.series[5].data=b.redirectData,a.chartConfig.series[6].data=b.dnsData,a.chartConfig.series[7].data=b.connectData,a.chartConfig.series[8].data=b.waitingData,a.chartConfig.series[9].data=b.receivingData,a.chartConfig.series[10].data=b.processingData,a.chartConfig.series[11].data=b.contentLoadedData,a.chartConfig.series[12].data=b.onLoadData,a.timingPie.series[0].data=[["网络",b.statisticData.network/b.statisticData.pageLoad*100],["后端",b.statisticData.backend/b.statisticData.pageLoad*100],{name:"前端",y:b.statisticData.frontend/b.statisticData.pageLoad*100,sliced:!0,selected:!0},["其它",(b.statisticData.pageLoad-b.statisticData.network-b.statisticData.backend-b.statisticData.frontend)/b.statisticData.pageLoad*100]],a.timingline.series[0].data=[[1*b.statisticData.dnsTime,1*b.statisticData.dnsTime+1*b.statisticData.dns],[1*b.statisticData.connectTime,1*b.statisticData.connectTime+1*b.statisticData.connect],[1*b.statisticData.requestTime,1*b.statisticData.requestTime+1*b.statisticData.waiting],[1*b.statisticData.receiveTime,1*b.statisticData.receiveTime+1*b.statisticData.receiving],[1*b.statisticData.processTime,1*b.statisticData.processTime+1*b.statisticData.processing],[1*b.statisticData.contentLoadedTime,1*b.statisticData.contentLoadedTime+1*b.statisticData.contentLoaded],[1*b.statisticData.onLoadTime,1*b.statisticData.onLoadTime+1*b.statisticData.onLoad],[0,1*b.statisticData.pageLoadTime]],a.statisticData=b.statisticData,a.showData=!0):a.showData=!1})};a.chartConfig={options:{tooltip:{xDateFormat:"%Y-%m-%d",shared:!0},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){g.get("timings",{params:{pageId:a.selectPage._id,dateNumber:this.category,interval:a.selectInterval.id,browser:a.selectBrowser.id}}).success(function(b){a.details=b.data;for(var c=[],d=[],e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=0;l<b.data.length;l++){var m=Date.parse(b.data[l].created);c.push([m,b.data[l].pageLoad]),g.push([m,b.data[l].waiting]),h.push([m,b.data[l].receiving]),j.push([m,b.data[l].contentLoaded]),d.push([m,b.data[l].redirect]),e.push([m,b.data[l].dns]),f.push([m,b.data[l].connect]),i.push([m,b.data[l].processing]),k.push([m,b.data[l].onLoad])}a.timingArea.series[0].data=c,a.timingArea.series[1].data=d,a.timingArea.series[2].data=e,a.timingArea.series[3].data=f,a.timingArea.series[4].data=g,a.timingArea.series[5].data=h,a.timingArea.series[6].data=i,a.timingArea.series[7].data=j,a.timingArea.series[8].data=k})}}}}}},credits:{enabled:!1},xAxis:{title:{text:"日期",align:"high"},type:"datetime",tickInterval:864e5,dateTimeLabelFormats:{day:"%m.%d",month:"%Y.%m",year:"%Y"}},yAxis:[{title:{text:"耗时（ms）"}},{title:{text:"请求总数",style:{color:Highcharts.getOptions().colors[0]}},labels:{style:{color:Highcharts.getOptions().colors[0]}},allowDecimals:!1,opposite:!0}],series:[{name:"请求总数",type:"column",yAxis:1,data:[]},{name:"总耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"网络耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"后端耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"前端耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"页面跳转耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"DNS查询耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"连接耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"等待响应耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"接收文档耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"DOM处理耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"DOM内容加载耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"load事件耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]}],title:{text:""}},a.timingPie={options:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,marginTop:50},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}}},credits:{enabled:!1},title:{text:"页面加载耗时分布图(平均值)"},series:[{type:"pie",name:"占总耗时比率",data:[]}]},a.timingArea={options:{chart:{type:"areaspline",zoomType:"x",marginTop:50},plotOptions:{areaspline:{fillOpacity:.5,marker:{enabled:!1}}},tooltip:{shared:!0}},credits:{enabled:!1},xAxis:{title:{text:"日期",align:"high"},type:"datetime"},yAxis:{title:{text:"耗时（ms）"}},series:[{name:"总耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"页面跳转耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"DNS查询耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"连接耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"等待响应耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"接收文档耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"DOM处理耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"DOM内容加载耗时",tooltip:{valueSuffix:" ms"},data:[]},{name:"load事件耗时",tooltip:{valueSuffix:" ms"},data:[]}],title:{text:"真实请求趋势图"}},a.timingline={options:{chart:{type:"columnrange",inverted:!0,marginTop:50},legend:{enabled:!1},tooltip:{formatter:function(){return"<h6>"+this.key+"</h6><br/><table><tr><td>耗时: </td><td><b>"+(this.point.high-this.point.low).toFixed(2)+" ms</b></td></tr></table>"}},plotOptions:{columnrange:{dataLabels:{enabled:!0,formatter:function(){return this.y.toFixed(2)+"ms"}}}}},credits:{enabled:!1},xAxis:{categories:["DNS查询","连接","等待响应","接收文档","DOM处理","DOM内容加载","load事件","总耗时"]},yAxis:{title:{text:"时间线（ms）"}},series:[{name:"耗时",tooltip:{valueSuffix:" ms"},data:[]}],title:{text:"加载时间线"}},a.refrashChart=f,f(),a.reflow=function(){for(var a=0;a<Highcharts.charts.length;a++)Highcharts.charts[a]&&Highcharts.charts[a].reflow()}}else a.showChart=!1})},a.dtOptions=f.newOptions().withLanguage({sLengthMenu:"每页显示 _MENU_ 条数据",sInfo:"从 _START_ 到 _END_ /共 _TOTAL_ 条数据",sInfoEmpty:"没有数据",sInfoFiltered:"(从 _MAX_ 条数据中检索)",sZeroRecords:"没有检索到数据",sSearch:"检索:",oPaginate:{sFirst:"首页",sPrevious:"上一页",sNext:"下一页",sLast:"末页"}}).withBootstrap(),a.canUpdate=function(){return a.appForm.$valid},a.removeErr=function(){a.error=!1},a.back=function(){window.history.back()},a.findTiming=function(b){g.get("timings/"+b).success(function(b){a.timingData=b,a.resources=b.allResourcesCalc,a.timingErrs=b.errs})},a.sumTooltip={title:"页面请求总数"},a.pageLoadTooltip={title:"页面请求加载总耗时"},a.networkTooltip={title:"包括页面跳转、域名查询、请求连接耗时"},a.backendTooltip={title:"包括从客户端发出请求到服务端完成响应耗时"},a.frontendTooltip={title:"包括DOM加载、页面渲染耗时"},a.redirectTooltip={title:"页面页面跳转耗时"},a.dnsTooltip={title:"域名查询耗时"},a.connectTooltip={title:"请求连接耗时"},a.processingTooltip={title:"DOM加载耗时"},a.onLoadTooltip={title:"页面渲染耗时"},a.clip=function(){a.isClip=!0,h(function(){a.isClip=!1},3e3)}}]),angular.module("apps").directive("myConfirmClick",[function(){return{priority:-1,restrict:"A",link:function(a,b,c){b.bind("click",function(a){var b=c.myConfirmClick;b&&!confirm(b)&&(a.stopImmediatePropagation(),a.preventDefault())})}}}]),angular.module("apps").factory("Apps",["$resource",function(a){return a("apps/:appId",{appId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function(a,b,c){a.authentication=b,a.isCollapsed=!1,a.menu=c.getMenu("topbar"),a.toggleCollapsibleMenu=function(){a.isCollapsed=!a.isCollapsed},a.$on("$stateChangeSuccess",function(){a.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication",function(a,b){a.authentication=b}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var a=function(a){if(!a)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var b in a.roles)for(var c in this.roles)if(this.roles[c]===a.roles[b])return!0;return!1};this.validateMenuExistance=function(a){if(a&&a.length){if(this.menus[a])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(a){return this.validateMenuExistance(a),this.menus[a]},this.addMenu=function(b,c,d){return this.menus[b]={isPublic:c||!1,roles:d||this.defaultRoles,items:[],shouldRender:a},this.menus[b]},this.removeMenu=function(a){this.validateMenuExistance(a),delete this.menus[a]},this.addMenuItem=function(b,c,d,e,f,g,h,i){return this.validateMenuExistance(b),this.menus[b].items.push({title:c,link:d,menuItemType:e||"item",menuItemClass:e,uiRoute:f||"/"+d,isPublic:null===g||"undefined"==typeof g?this.menus[b].isPublic:g,roles:null===h||"undefined"==typeof h?this.menus[b].roles:h,position:i||0,items:[],shouldRender:a}),this.menus[b]},this.addSubMenuItem=function(b,c,d,e,f,g,h,i){this.validateMenuExistance(b);for(var j in this.menus[b].items)this.menus[b].items[j].link===c&&this.menus[b].items[j].items.push({title:d,link:e,uiRoute:f||"/"+e,isPublic:null===g||"undefined"==typeof g?this.menus[b].items[j].isPublic:g,roles:null===h||"undefined"==typeof h?this.menus[b].items[j].roles:h,position:i||0,shouldRender:a});return this.menus[b]},this.removeMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)this.menus[a].items[c].link===b&&this.menus[a].items.splice(c,1);return this.menus[a]},this.removeSubMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)for(var d in this.menus[a].items[c].items)this.menus[a].items[c].items[d].link===b&&this.menus[a].items[c].items.splice(d,1);return this.menus[a]},this.addMenu("topbar")}]),angular.module("users").config(["$httpProvider",function(a){a.interceptors.push(["$q","$location","Authentication",function(a,b,c){return{responseError:function(d){switch(d.status){case 401:c.user=null,b.path("signin");break;case 403:}return a.reject(d)}}}])}]),angular.module("users").run(["Menus",function(a){a.addMenuItem("topbar","用户列表","users","item","/users","false",["admin"])}]),angular.module("users").config(["$stateProvider",function(a){a.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"}).state("listUsers",{url:"/users",templateUrl:"modules/users/views/settings/list-users.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function(a,b,c,d){a.authentication=d,a.authentication.user&&c.path("/"),a.signup=function(){b.post("/auth/signup",a.credentials).success(function(){a.success=!0}).error(function(b){a.error=b.message})},a.signin=function(){b.post("/auth/signin",a.credentials).success(function(b){a.authentication.user=b,c.path("/")}).error(function(b){a.error=b.message})},a.removeErr=function(){a.error=!1}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function(a,b,c,d,e){a.authentication=e,a.authentication.user&&d.path("/"),a.askForPasswordReset=function(){a.success=a.error=null,c.post("/auth/forgot",a.credentials).success(function(b){a.credentials=null,a.success=b.message}).error(function(b){a.credentials=null,a.error=b.message})},a.resetUserPassword=function(){a.success=a.error=null,c.post("/auth/reset/"+b.token,a.passwordDetails).success(function(b){a.passwordDetails=null,e.user=b,d.path("/password/reset/success")}).error(function(b){a.error=b.message})},a.back=function(){window.history.back()}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication","DTOptionsBuilder",function(a,b,c,d,e,f){a.user=e.user,a.user||c.path("/"),a.updateUserProfile=function(b){if(b){a.success=a.error=null;var c=new d(a.user);c.$update(function(b){a.success=!0,e.user=b},function(b){a.error=b.data.message})}else a.submitted=!0},a.changeUserPassword=function(){a.success=a.error=null,b.post("/users/password",a.passwordDetails).success(function(){a.success=!0,a.passwordDetails=null}).error(function(b){a.error=b.message})},a.find=function(){a.users=d.query()},a.dtOptions=f.newOptions().withLanguage({sLengthMenu:"每页显示 _MENU_ 条数据",sInfo:"从 _START_ 到 _END_ /共 _TOTAL_ 条数据",sInfoEmpty:"没有数据",sInfoFiltered:"(从 _MAX_ 条数据中检索)",sZeroRecords:"没有检索到数据",sSearch:"检索:",oPaginate:{sFirst:"首页",sPrevious:"上一页",sNext:"下一页",sLast:"末页"}}).withBootstrap(),a.change=function(b){a.success=a.error=null,b.$update(function(){a.success=!0},function(b){a.error=b.data.message})},a.back=function(){window.history.back()}}]),angular.module("users").factory("Authentication",[function(){var a=this;return a._data={user:window.user},a._data}]),angular.module("users").factory("Users",["$resource",function(a){return a("users",{},{update:{method:"PUT"}})}]);